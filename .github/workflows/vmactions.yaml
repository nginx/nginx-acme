name: VM

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  CARGO_TERM_COLOR: 'always'
  NGINX_SOURCE_DIR: nginx
  TEST_NGINX_GLOBALS: 'user root nobody;'

jobs:
  freebsd:
    name: FreeBSD
    runs-on: ubuntu-latest
    env:
      BUILDREQUIRES: >-
        git
        go
        llvm
        p5-Digest-SHA
        p5-IO-Socket-INET6
        p5-IO-Socket-SSL
        p5-JSON-PP
        p5-TimeDate
        pcre2
        pkgconf
        rust

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ matrix.nginx-ref }}
          repository: 'nginx/nginx'
          path: 'nginx'
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: 'nginx/nginx-tests'
          path: 'nginx/tests'

      - uses: vmactions/freebsd-vm@80bcb19d617fe71c9db00e6297b16fb184dac498 # v1.4.1
        with:
          copyback: false
          envs: 'CARGO_TERM_COLOR NGINX_SOURCE_DIR TEST_NGINX_GLOBALS'
          prepare: |
            pkg install -y ${{ env.BUILDREQUIRES }}
          run: |
            TEST_NGINX_PEBBLE_BINARY=$(perl build/get-pebble.pl)
            export TEST_NGINX_PEBBLE_BINARY
            make

  netbsd:
    name: NetBSD
    runs-on: ubuntu-latest
    env:
      GO: go124
      BUILDREQUIRES: >-
        clang
        git
        go124
        p5-IO-Socket-INET6
        p5-IO-Socket-SSL
        p5-TimeDate
        pcre2
        pkgconf
        rust

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ matrix.nginx-ref }}
          repository: 'nginx/nginx'
          path: 'nginx'
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: 'nginx/nginx-tests'
          path: 'nginx/tests'

      - uses: vmactions/netbsd-vm@f83456a40093f1a18df4cda4a35335468d8e15a7 # v1.2.6
        with:
          copyback: false
          envs: 'CARGO_TERM_COLOR NGINX_SOURCE_DIR TEST_NGINX_GLOBALS GO'
          prepare: |
            /usr/sbin/pkg_add -u ${{ env.BUILDREQUIRES }}
          run: |
            TEST_NGINX_PEBBLE_BINARY=$(perl build/get-pebble.pl)
            export TEST_NGINX_PEBBLE_BINARY
            make
